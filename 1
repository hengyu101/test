// ==UserScript==
// @name         YouTube to Gemini è‡ªåŠ¨æ€»ç»“ä¸å­—å¹• (ä¼˜åŒ–ç‰ˆ)
// @namespace    http://tampermonkey.net/
// @version      2.3
// @description  YouTube é¦–é¡µ/æœç´¢åˆ†æ®µç¼©ç•¥å›¾ç½‘æ ¼100%ä¿®å¤ï¼ŒGeminiä¸€é”®æ€»ç»“/å­—å¹• (æ€§èƒ½ä¼˜åŒ–ç‰ˆ)
// @author       hengyu (ä¼˜åŒ– by Assistant)
// @match        *://www.youtube.com/*
// @match        *://gemini.google.com/*
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_deleteValue
// @grant        GM_addStyle
// @run-at       document-start
// @license      MIT
// @downloadURL https://update.greasyfork.org/scripts/535000/YouTube%20to%20Gemini%20%E8%87%AA%E5%8A%A8%E6%80%BB%E7%BB%93%E4%B8%8E%E5%AD%97%E5%B9%95%20%28%E4%BC%98%E5%8C%96%E7%89%88%29.user.js
// @updateURL https://update.greasyfork.org/scripts/535000/YouTube%20to%20Gemini%20%E8%87%AA%E5%8A%A8%E6%80%BB%E7%BB%93%E4%B8%8E%E5%AD%97%E5%B9%95%20%28%E4%BC%98%E5%8C%96%E7%89%88%29.meta.js
// ==/UserScript==

(function() {
    'use strict';

    // --- æ€§èƒ½ä¼˜åŒ–å˜é‡ ---
    let debounceTimer = null;
    let lastProcessedCount = 0;
    // ä¿®å¤é—®é¢˜2ï¼šä½¿ç”¨Mapæ›¿ä»£WeakSetï¼Œå¯ä»¥æ¸…ç†å’Œé‡æ–°å¤„ç†
    const processedElements = new Map(); // key: element, value: {videoId, timestamp}
    const ELEMENT_CACHE_TIME = 60000; // 1åˆ†é’Ÿåå…è®¸é‡æ–°å¤„ç†

    // --- ç»ˆæåˆ†æ®µç½‘æ ¼ä¿®å¤ CSS ---
    // åªå¯¹é¦–é¡µå’Œæœç´¢ç»“æœé¡µé¢åº”ç”¨ç½‘æ ¼å¸ƒå±€ä¿®å¤
    GM_addStyle(`
    /* é¦–é¡µå’Œæœç´¢é¡µé¢ç½‘æ ¼å¸ƒå±€ */
    body[data-is-home-page="true"] ytd-rich-grid-renderer > #contents,
    body[data-page-subtype="home"] ytd-rich-grid-renderer > #contents,
    body[data-page-type="search"] ytd-rich-grid-renderer > #contents {
        display: grid !important;
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 24px 16px !important;
        width: 100% !important;
        margin: 0 auto !important;
        --ytd-rich-grid-items-per-row: 2 !important;
        --ytd-rich-grid-max-width: none !important;
    }
    @media (min-width: 1000px) {
        body[data-is-home-page="true"] ytd-rich-grid-renderer > #contents,
        body[data-page-subtype="home"] ytd-rich-grid-renderer > #contents,
        body[data-page-type="search"] ytd-rich-grid-renderer > #contents {
            grid-template-columns: repeat(3, 1fr) !important;
            --ytd-rich-grid-items-per-row: 3 !important;
        }
    }
    @media (min-width: 1400px) {
        body[data-is-home-page="true"] ytd-rich-grid-renderer > #contents,
        body[data-page-subtype="home"] ytd-rich-grid-renderer > #contents,
        body[data-page-type="search"] ytd-rich-grid-renderer > #contents {
            grid-template-columns: repeat(4, 1fr) !important;
            --ytd-rich-grid-items-per-row: 4 !important;
        }
    }
    @media (min-width: 1700px) {
        body[data-is-home-page="true"] ytd-rich-grid-renderer > #contents,
        body[data-page-subtype="home"] ytd-rich-grid-renderer > #contents,
        body[data-page-type="search"] ytd-rich-grid-renderer > #contents {
            grid-template-columns: repeat(5, 1fr) !important;
            --ytd-rich-grid-items-per-row: 5 !important;
        }
    }

    /* ç¡®ä¿åªåœ¨é¦–é¡µå’Œæœç´¢é¡µé¢ä¿®æ”¹å¸ƒå±€ç»“æ„ */
    body[data-is-home-page="true"] ytd-rich-grid-row,
    body[data-is-home-page="true"] ytd-rich-grid-row > #contents,
    body[data-is-home-page="true"] ytd-rich-grid-row > #dismissible,
    body[data-is-home-page="true"] ytd-rich-grid-row > div,
    body[data-is-home-page="true"] ytd-rich-grid-row > #dismissible > #contents,
    body[data-is-home-page="true"] ytd-rich-grid-row > div > #contents,
    body[data-is-home-page="true"] ytd-rich-grid-row > div > #dismissible,
    body[data-is-home-page="true"] ytd-rich-grid-row > div > #dismissible > #contents,
    body[data-is-home-page="true"] ytd-rich-grid-row > .ytd-rich-grid-row,
    body[data-is-home-page="true"] ytd-rich-grid-row > div > .ytd-rich-grid-row,
    body[data-is-home-page="true"] ytd-rich-grid-row > div > div,
    body[data-is-home-page="true"] ytd-rich-grid-row > div > div > #contents,
    body[data-page-subtype="home"] ytd-rich-grid-row,
    body[data-page-subtype="home"] ytd-rich-grid-row > #contents,
    body[data-page-subtype="home"] ytd-rich-grid-row > #dismissible,
    body[data-page-subtype="home"] ytd-rich-grid-row > div,
    body[data-page-subtype="home"] ytd-rich-grid-row > #dismissible > #contents,
    body[data-page-subtype="home"] ytd-rich-grid-row > div > #contents,
    body[data-page-subtype="home"] ytd-rich-grid-row > div > #dismissible,
    body[data-page-subtype="home"] ytd-rich-grid-row > div > #dismissible > #contents,
    body[data-page-subtype="home"] ytd-rich-grid-row > .ytd-rich-grid-row,
    body[data-page-subtype="home"] ytd-rich-grid-row > div > .ytd-rich-grid-row,
    body[data-page-subtype="home"] ytd-rich-grid-row > div > div,
    body[data-page-subtype="home"] ytd-rich-grid-row > div > div > #contents,
    body[data-page-type="search"] ytd-rich-grid-row,
    body[data-page-type="search"] ytd-rich-grid-row > #contents,
    body[data-page-type="search"] ytd-rich-grid-row > #dismissible,
    body[data-page-type="search"] ytd-rich-grid-row > div,
    body[data-page-type="search"] ytd-rich-grid-row > #dismissible > #contents,
    body[data-page-type="search"] ytd-rich-grid-row > div > #contents,
    body[data-page-type="search"] ytd-rich-grid-row > div > #dismissible,
    body[data-page-type="search"] ytd-rich-grid-row > div > #dismissible > #contents,
    body[data-page-type="search"] ytd-rich-grid-row > .ytd-rich-grid-row,
    body[data-page-type="search"] ytd-rich-grid-row > div > .ytd-rich-grid-row,
    body[data-page-type="search"] ytd-rich-grid-row > div > div,
    body[data-page-type="search"] ytd-rich-grid-row > div > div > #contents {
        display: contents !important;
    }

    /* è§†é¢‘é¡¹ä¿®å¤ - ä»…é™é¦–é¡µå’Œæœç´¢é¡µé¢ */
    body[data-is-home-page="true"] ytd-rich-item-renderer,
    body[data-is-home-page="true"] ytd-grid-video-renderer,
    body[data-is-home-page="true"] ytd-rich-grid-media,
    body[data-page-subtype="home"] ytd-rich-item-renderer,
    body[data-page-subtype="home"] ytd-grid-video-renderer,
    body[data-page-subtype="home"] ytd-rich-grid-media,
    body[data-page-type="search"] ytd-rich-item-renderer,
    body[data-page-type="search"] ytd-grid-video-renderer,
    body[data-page-type="search"] ytd-rich-grid-media {
        width: 100% !important;
        max-width: none !important;
        min-width: 0 !important;
        margin: 0 !important;
        box-sizing: border-box !important;
    }

    /* å¼¹æ€§é¡¹ - ä»…é¦–é¡µå’Œæœç´¢é¡µé¢ */
    body[data-is-home-page="true"] ytd-rich-grid-renderer > #contents > ytd-rich-section-renderer,
    body[data-is-home-page="true"] ytd-rich-grid-renderer > #contents > ytd-reel-shelf-renderer,
    body[data-page-subtype="home"] ytd-rich-grid-renderer > #contents > ytd-rich-section-renderer,
    body[data-page-subtype="home"] ytd-rich-grid-renderer > #contents > ytd-reel-shelf-renderer,
    body[data-page-type="search"] ytd-rich-grid-renderer > #contents > ytd-rich-section-renderer,
    body[data-page-type="search"] ytd-rich-grid-renderer > #contents > ytd-reel-shelf-renderer {
        grid-column: 1 / -1 !important;
        width: 100% !important;
        margin: 16px 0 !important;
    }

    /* æœç´¢é¡µé¢ä¿®å¤ */
    ytd-search ytd-video-renderer {
        display: block !important;
        position: relative !important;
        z-index: 1 !important;
    }

    ytd-search ytd-thumbnail {
        position: relative !important;
        z-index: 5 !important;
    }
    `);

    // --- Gemini æŒ‰é’®ä¸äº¤äº’ ---
    const PROMPT_KEY = 'geminiPrompt';
    const TITLE_KEY = 'videoTitle';
    const ORIGINAL_TITLE_KEY = 'geminiOriginalVideoTitle';
    const TIMESTAMP_KEY = 'timestamp';
    const ACTION_TYPE_KEY = 'geminiActionType';
    const VIDEO_TOTAL_DURATION_KEY = 'geminiVideoTotalDuration';
    const FIRST_SEGMENT_END_TIME_KEY = 'geminiFirstSegmentEndTime';
    const SUMMARY_BUTTON_ID = 'gemini-summarize-btn';
    const SUBTITLE_BUTTON_ID = 'gemini-subtitle-btn';
    const THUMBNAIL_BUTTON_CLASS = 'gemini-thumbnail-btn';
    const THUMBNAIL_PROCESSED_FLAG = 'data-gemini-processed';
    const YOUTUBE_NOTIFICATION_ID = 'gemini-yt-notification';
    const YOUTUBE_CONFIRMATION_ID = 'gemini-yt-confirmation';
    // ä¿®å¤é—®é¢˜3ï¼šæ·»åŠ å”¯ä¸€ä¼šè¯ID
    const SESSION_ID_KEY = 'geminiSessionId';

    // æ¢å¤åŸå§‹é€šçŸ¥æ ·å¼
    const YOUTUBE_NOTIFICATION_STYLE = {
        position: 'fixed', bottom: '20px', left: '50%', transform: 'translateX(-50%)',
        backgroundColor: 'rgba(0,0,0,0.85)', color: 'white', padding: '15px 35px 15px 20px',
        borderRadius: '8px', zIndex: '99999', maxWidth: 'calc(100% - 40px)', textAlign: 'left',
        boxSizing: 'border-box', whiteSpace: 'pre-wrap',
        boxShadow: '0 4px 12px rgba(0,0,0,0.3)'
    };
    const YOUTUBE_CONFIRMATION_STYLE = {
        position: 'fixed', top: '50%', left: '50%', transform: 'translate(-50%, -50%)',
        backgroundColor: 'rgba(33, 33, 33, 0.95)', color: 'white', padding: '20px 25px',
        borderRadius: '12px', zIndex: '999999', maxWidth: 'calc(100% - 60px)', minWidth: '300px',
        boxSizing: 'border-box', boxShadow: '0 8px 24px rgba(0,0,0,0.5)',
        display: 'flex', flexDirection: 'column', gap: '15px'
    };

    // ç¼©ç•¥å›¾æŒ‰é’®æ ·å¼
    GM_addStyle(`
    .${THUMBNAIL_BUTTON_CLASS} {
        position: absolute;
        top: 5px;
        right: 5px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 12px;
        cursor: pointer;
        z-index: 9999;
        display: flex;
        align-items: center;
        opacity: 0;
        transition: opacity 0.2s ease;
        pointer-events: auto !important;
    }
    #dismissible:hover .${THUMBNAIL_BUTTON_CLASS},
    ytd-grid-video-renderer:hover .${THUMBNAIL_BUTTON_CLASS},
    ytd-video-renderer:hover .${THUMBNAIL_BUTTON_CLASS},
    ytd-rich-item-renderer:hover .${THUMBNAIL_BUTTON_CLASS},
    ytd-compact-video-renderer:hover .${THUMBNAIL_BUTTON_CLASS},
    ytd-playlist-video-renderer:hover .${THUMBNAIL_BUTTON_CLASS},
    ytd-reel-item-renderer:hover .${THUMBNAIL_BUTTON_CLASS},
    ytd-search ytd-video-renderer:hover .${THUMBNAIL_BUTTON_CLASS} {
        opacity: 1 !important;
        visibility: visible !important;
        pointer-events: auto !important;
    }
    .${THUMBNAIL_BUTTON_CLASS}:hover {
        background-color: rgba(0, 0, 0, 0.9);
        opacity: 1 !important;
        visibility: visible !important;
    }

    /* æœç´¢é¡µé¢è§†é¢‘é¢„è§ˆæ—¶çš„ç‰¹æ®Šå¤„ç† */
    ytd-search .ytp-inline-preview-scrim ~ .${THUMBNAIL_BUTTON_CLASS},
    ytd-search video ~ .${THUMBNAIL_BUTTON_CLASS},
    ytd-search .html5-video-player ~ .${THUMBNAIL_BUTTON_CLASS} {
        opacity: 1 !important;
        visibility: visible !important;
        pointer-events: auto !important;
        z-index: 99999 !important;
    }

    /* ç¡®ä¿æœç´¢é¡µé¢çš„æŒ‰é’®åœ¨è§†é¢‘é¢„è§ˆæ—¶ä»ç„¶å¯è§ */
    ytd-search ytd-video-renderer:has(video) .${THUMBNAIL_BUTTON_CLASS},
    ytd-search ytd-video-renderer:has(.ytp-inline-preview-scrim) .${THUMBNAIL_BUTTON_CLASS} {
        opacity: 1 !important;
        z-index: 99999 !important;
    }

    .gemini-confirmation-btn {
        padding: 8px 20px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        font-weight: 500;
        font-size: 14px;
        transition: background-color 0.2s ease;
    }
    .gemini-confirmation-confirm {
        background-color: #1a73e8;
        color: white;
    }
    .gemini-confirmation-confirm:hover {
        background-color: #0d65d9;
    }
    .gemini-confirmation-cancel {
        background-color: #5f6368;
        color: white;
        margin-right: 10px;
    }
    .gemini-confirmation-cancel:hover {
        background-color: #494c50;
    }
    `);

    // è¾…åŠ©å‡½æ•°
    function showNotification(elementId, message, styles, duration = 15000) {
        let existing = document.getElementById(elementId);
        if (existing) {
            clearTimeout(parseInt(existing.dataset.timeoutId));
            existing.remove();
        }
        const notif = document.createElement('div');
        notif.id = elementId;
        notif.textContent = message;
        Object.assign(notif.style, styles);
        document.body.appendChild(notif);
        const btn = document.createElement('button');
        btn.textContent = 'âœ•';
        Object.assign(btn.style, { position: 'absolute', top: '5px', right: '10px', background: 'transparent', border: 'none', color: 'inherit', fontSize: '16px', cursor: 'pointer', padding: '0', lineHeight: '1' });
        btn.onclick = () => notif.remove();
        notif.appendChild(btn);
        notif.dataset.timeoutId = setTimeout(() => notif.remove(), duration).toString();
        return notif;
    }

    function showConfirmation(elementId, title, message, videoInfo, onConfirm, onCancel, styles) {
        let existing = document.getElementById(elementId);
        if (existing) existing.remove();

        const dialog = document.createElement('div');
        dialog.id = elementId;
        Object.assign(dialog.style, styles);
        document.body.appendChild(dialog);

        const titleElem = document.createElement('h3');
        titleElem.textContent = title;
        titleElem.style.margin = '0 0 10px 0';
        titleElem.style.fontSize = '18px';

        const messageElem = document.createElement('div');
        messageElem.textContent = message;
        messageElem.style.marginBottom = '15px';
        messageElem.style.fontSize = '14px';

        const videoTitleElem = document.createElement('div');
        videoTitleElem.textContent = `è§†é¢‘æ ‡é¢˜: ${videoInfo.title}`;
        videoTitleElem.style.marginBottom = '5px';
        videoTitleElem.style.fontWeight = 'bold';

        const videoIdElem = document.createElement('div');
        videoIdElem.textContent = `è§†é¢‘ID: ${videoInfo.id}`;
        videoIdElem.style.fontSize = '12px';
        videoIdElem.style.color = '#aaa';
        videoIdElem.style.marginBottom = '15px';

        const buttonsContainer = document.createElement('div');
        buttonsContainer.style.display = 'flex';
        buttonsContainer.style.justifyContent = 'flex-end';
        buttonsContainer.style.gap = '10px';

        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'å–æ¶ˆ';
        cancelBtn.className = 'gemini-confirmation-btn gemini-confirmation-cancel';
        cancelBtn.onclick = () => {
            dialog.remove();
            if (onCancel) onCancel();
        };

        const confirmBtn = document.createElement('button');
        confirmBtn.textContent = 'ç¡®è®¤';
        confirmBtn.className = 'gemini-confirmation-btn gemini-confirmation-confirm';
        confirmBtn.onclick = () => {
            dialog.remove();
            if (onConfirm) onConfirm(videoInfo);
        };

        buttonsContainer.appendChild(cancelBtn);
        buttonsContainer.appendChild(confirmBtn);

        dialog.appendChild(titleElem);
        dialog.appendChild(messageElem);
        dialog.appendChild(videoTitleElem);
        dialog.appendChild(videoIdElem);
        dialog.appendChild(buttonsContainer);

        return dialog;
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).catch(() => {
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed'; ta.style.opacity = '0';
            document.body.appendChild(ta);
            ta.select();
            try { document.execCommand('copy'); } catch {}
            document.body.removeChild(ta);
        });
    }

    function isVideoPage() {
        return window.location.pathname === '/watch' && new URLSearchParams(window.location.search).has('v');
    }

    // éªŒè¯YouTubeè§†é¢‘IDæ ¼å¼
    function isValidYouTubeVideoId(id) {
        return id && typeof id === 'string' && /^[A-Za-z0-9_-]{11}$/.test(id);
    }

    // ç”Ÿæˆå”¯ä¸€ä¼šè¯ID
    function generateSessionId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    // --- ä¼˜åŒ–åçš„è§†é¢‘ä¿¡æ¯æå–å‡½æ•° ---
    function getVideoInfoFromElement(element) {
        // ä¿®å¤é—®é¢˜2ï¼šæ£€æŸ¥ç¼“å­˜æ˜¯å¦è¿‡æœŸ
        const cached = processedElements.get(element);
        if (cached && (Date.now() - cached.timestamp < ELEMENT_CACHE_TIME)) {
            return null; // ä»åœ¨ç¼“å­˜æœŸå†…
        }

        let videoId = '';
        let videoTitle = '';

        // ä¼˜åŒ–ï¼šä¼˜å…ˆæ£€æŸ¥æœ€å¯èƒ½çš„æ•°æ®å±æ€§
        const possibleIdSources = [
            () => element.dataset?.videoId,
            () => element.getAttribute('video-id'),
            () => {
                // ä¼˜åŒ–çš„é“¾æ¥æŸ¥æ‰¾ - ä½¿ç”¨æ›´ç²¾ç¡®çš„é€‰æ‹©å™¨
                const link = element.querySelector('a[href*="/watch?v="]:first-child');
                if (link) {
                    const match = link.href.match(/\/watch\?v=([^&]+)/);
                    return match?.[1];
                }
            },
            () => {
                // ä¼˜åŒ–çš„ç¼©ç•¥å›¾æŸ¥æ‰¾
                const img = element.querySelector('img[src*="/vi/"]:first-child, img[src*="i.ytimg.com"]:first-child');
                if (img) {
                    const match = img.src.match(/\/vi\/([^\/]+)\//) || img.src.match(/\/([A-Za-z0-9_-]{11})\/[\w]+\.jpg/);
                    return match?.[1];
                }
            }
        ];

        // æŒ‰ä¼˜å…ˆçº§å°è¯•è·å–è§†é¢‘ID
        for (const getSource of possibleIdSources) {
            const id = getSource();
            if (isValidYouTubeVideoId(id)) {
                videoId = id;
                break;
            }
        }

        // ä¼˜åŒ–çš„æ ‡é¢˜æå– - æŒ‰ä¼˜å…ˆçº§æ’åº
        const titleSelectors = [
            '#video-title',
            'h3 a[title]',
            '.title[title]',
            'yt-formatted-string[title]',
            'span[title]'
        ];

        for (const selector of titleSelectors) {
            const titleElement = element.querySelector(selector);
            if (titleElement) {
                const possibleTitle = titleElement.textContent?.trim() ||
                                     titleElement.getAttribute('title')?.trim();
                if (possibleTitle && possibleTitle.length > 5) {
                    videoTitle = possibleTitle;
                    break;
                }
            }
        }

        // éªŒè¯ç»“æœ
        if (!isValidYouTubeVideoId(videoId) || !videoTitle) {
            return null;
        }

        // æ›´æ–°ç¼“å­˜
        processedElements.set(element, {
            videoId: videoId,
            timestamp: Date.now()
        });

        return {
            id: videoId,
            title: videoTitle,
            url: `https://www.youtube.com/watch?v=${videoId}`
        };
    }

    function processVideoSummary(videoInfo) {
        const prompt = `è¯·åˆ†æè¿™ä¸ªYouTubeè§†é¢‘: ${videoInfo.url}

  è¯·æ‰§è¡Œä»¥ä¸‹ä¸¤é¡¹ä»»åŠ¡ï¼š

  ---
  **ä»»åŠ¡ 1: æ ¸å¿ƒå‘½é¢˜å›åº”**

  *   è¯·é¦–å…ˆåˆ†ææ­¤è§†é¢‘æ ‡é¢˜çš„ã€æ ¸å¿ƒæ„å›¾æˆ–éšå«å‘½é¢˜ã€‘ã€‚
  *   åˆ¤æ–­æ ‡é¢˜æ˜¯å¦æå‡ºæˆ–æš—ç¤ºäº†ä¸€ä¸ªæ ¸å¿ƒé—®é¢˜ï¼ˆä¾‹å¦‚åŒ…å«â€œä¸ºä»€ä¹ˆ/Whyâ€ã€â€œå¦‚ä½•/Howâ€ã€â€œæ˜¯ä»€ä¹ˆ/Whatâ€ã€â€œæ­ç§˜â€ã€â€œåŸå› â€ã€â€œæ–¹æ³•â€ã€â€œå‡­ä»€ä¹ˆâ€ã€â€œåŸç†â€ç­‰è¯è¯­ï¼Œæˆ–è®¾å®šäº†ä¸€ä¸ªéœ€è¦è§£é‡Šçš„æ ¸å¿ƒè®ºæ–­ï¼‰ï¼Œã€è¯·æ³¨æ„ï¼šåˆ¤æ–­ä¾æ®æ˜¯è¯­ä¹‰å’Œæ„å›¾ï¼Œè€Œä¸ä»…ä»…æ˜¯çœ‹ç»“å°¾æ˜¯å¦æœ‰é—®å·ã€‘ã€‚
  *   å¦‚æœå­˜åœ¨è¿™æ ·çš„é—®é¢˜æˆ–å‘½é¢˜ï¼šè¯·åœ¨æ­¤å¤„ä»¥ ã€ğŸ“Œ æ ¸å¿ƒå›åº”ã€‘: å¼€å¤´ï¼Œç”¨ä¸€ä¸ªç‹¬ç«‹æ®µè½ï¼Œæ¸…æ™°ã€ç›´æ¥åœ°è¯´æ˜è§†é¢‘å†…å®¹å¯¹è¯¥æ ‡é¢˜æ ¸å¿ƒé—®é¢˜/å‘½é¢˜çš„ç­”æ¡ˆæˆ–è§£é‡Šã€‚
      ï¼ˆä¾‹å¦‚ï¼šå¯¹äºæ ‡é¢˜â€œå’–å•¡é£é¡å…¨çƒçš„ç§˜å¯†â€ï¼Œæ ¸å¿ƒå›åº”éœ€è§£é‡Šå’–å•¡å—æ¬¢è¿çš„å…·ä½“åŸå› ï¼‰ã€‚
  *   å›ç­”å¹²è„†å‡†ç¡®ï¼Œç›´å‡»é—®é¢˜ï¼Œæ— éœ€è§£é‡Šåˆ†ææ€è·¯ï¼Œèƒ½ä¸€å¥è¯è¯´æ¸…å°±ä¸è¦é‡å¤ï¼Œåšåˆ°ä¸€å­—åƒé‡‘ã€‚
  *   é—®é¢˜ä¸ç­”æ¡ˆåˆ†æ®µå›ç­”ï¼Œä½†ä¸è¦æ®µè½æ•°è¿‡å¤šã€‚
  *   å¦‚æœæ ‡é¢˜çº¯ç²¹æ˜¯é™ˆè¿°æ€§ä¸”ä¸å«ä»»ä½•å¾…è§£ç­”çš„å‘½é¢˜ï¼šåˆ™è¯´æ˜â€œæ ‡é¢˜ä¸ºé™ˆè¿°æ€§ï¼Œä¸åŒ…å«å¾…è§£ç­”çš„éšå«é—®é¢˜ã€‚â€

  **ä»»åŠ¡ 2: å…¨é¢ç»“æ„åŒ–æ‘˜è¦**

  *  ï¼ˆç´§æ¥ä»»åŠ¡1çš„ç»“æœï¼‰ç„¶åï¼Œè¯·æä¾›ä¸€ä¸ªå…¨é¢çš„è§†é¢‘å†…å®¹æ‘˜è¦ã€‚
  *  è¦æ±‚åŒ…æ‹¬ï¼šä¸»è¦è§‚ç‚¹ã€å…³é”®è§è§£ã€æ”¯æ’‘è§‚ç‚¹çš„è®ºæ®/æ¡ˆä¾‹/ç»†èŠ‚ã€ä»¥åŠè§†é¢‘ä¸­è®¨è®ºçš„é‡è¦ç»†èŠ‚ã€‚
  *  è¯·ä»¥æ¸…æ™°ã€æœ‰é€»è¾‘ã€ç»“æ„åŒ–ä¸”ã€è¿è´¯æµç•…ã€‘çš„æ–¹å¼åˆ†è§£å†…å®¹ï¼ˆä¾‹å¦‚æŒ‰æ—¶é—´çº¿ã€æŒ‰é€»è¾‘åˆ†å—ï¼‰ï¼Œç¡®ä¿è¡Œæ–‡è‡ªç„¶ï¼Œæ˜“äºé˜…è¯»ï¼Œå¹¶åŒ…æ‹¬ä»»ä½•é‡è¦çš„ç»“è®ºæˆ–è¦ç‚¹ã€‚

  ---
  è¯·å¼€å§‹åˆ†æã€‚
`;



        // ä¿®å¤é—®é¢˜3ï¼šç”Ÿæˆå”¯ä¸€ä¼šè¯ID
        const sessionId = generateSessionId();

        GM_setValue(PROMPT_KEY, prompt);
        GM_setValue(TITLE_KEY, videoInfo.title);
        GM_setValue(ORIGINAL_TITLE_KEY, videoInfo.title);
        GM_setValue(TIMESTAMP_KEY, Date.now());
        GM_setValue(ACTION_TYPE_KEY, 'summary');
        GM_setValue(SESSION_ID_KEY, sessionId);

        window.open('https://gemini.google.com/', '_blank');

        showNotification(
            YOUTUBE_NOTIFICATION_ID,
            `å·²è·³è½¬åˆ° Geminiï¼\nç³»ç»Ÿå°†å°è¯•è‡ªåŠ¨è¾“å…¥æç¤ºè¯å¹¶å‘é€è¯·æ±‚ã€‚\n\nè§†é¢‘: "${videoInfo.title}"\n\n(å¦‚æœè‡ªåŠ¨æ“ä½œå¤±è´¥ï¼Œæç¤ºè¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œè¯·æ‰‹åŠ¨ç²˜è´´)`,
            YOUTUBE_NOTIFICATION_STYLE,
            10000
        );

        copyToClipboard(prompt);
    }

    function handleThumbnailButtonClick(event, videoInfo) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
            event.stopImmediatePropagation();
            if (event.cancelable) event.returnValue = false;
        }

        if (!videoInfo || !videoInfo.url || !videoInfo.title) {
            showNotification(
                YOUTUBE_NOTIFICATION_ID,
                "æ— æ³•è·å–è§†é¢‘ä¿¡æ¯ï¼Œè¯·å°è¯•ç›´æ¥åœ¨è§†é¢‘é¡µé¢ä½¿ç”¨æ€»ç»“åŠŸèƒ½ã€‚",
                { ...YOUTUBE_NOTIFICATION_STYLE, backgroundColor: '#d93025' },
                5000
            );
            return false;
        }

        if (!isValidYouTubeVideoId(videoInfo.id)) {
            showNotification(
                YOUTUBE_NOTIFICATION_ID,
                `è·å–åˆ°çš„è§†é¢‘IDæ ¼å¼æ— æ•ˆ: ${videoInfo.id}\nè¯·å°è¯•ç›´æ¥åœ¨è§†é¢‘é¡µé¢ä½¿ç”¨æ€»ç»“åŠŸèƒ½ã€‚`,
                { ...YOUTUBE_NOTIFICATION_STYLE, backgroundColor: '#d93025' },
                5000
            );
            return false;
        }

        showConfirmation(
            YOUTUBE_CONFIRMATION_ID,
            "ç¡®è®¤è§†é¢‘ä¿¡æ¯",
            "è¯·ç¡®è®¤ä»¥ä¸‹è§†é¢‘ä¿¡æ¯æ˜¯å¦æ­£ç¡®:",
            videoInfo,
            processVideoSummary,
            null,
            YOUTUBE_CONFIRMATION_STYLE
        );

        return false;
    }

    // --- ä¼˜åŒ–åçš„ç¼©ç•¥å›¾æŒ‰é’®æ·»åŠ å‡½æ•° ---
    function addThumbnailButtons() {
        if (isVideoPage()) return;

        const isSearchPage = window.location.pathname === '/results';

        // ä¼˜åŒ–ï¼šä½¿ç”¨æ›´ç²¾ç¡®çš„é€‰æ‹©å™¨ï¼Œå‡å°‘è¯¯åŒ¹é…
        const videoElementSelectors = isSearchPage ? [
            'ytd-search ytd-video-renderer:has(ytd-thumbnail)',
            'ytd-video-renderer:has(#thumbnail)'
        ] : [
            'ytd-rich-item-renderer:has(ytd-thumbnail)',
            'ytd-grid-video-renderer:has(#thumbnail)',
            'ytd-compact-video-renderer:has(ytd-thumbnail)',
            'ytd-playlist-video-renderer:has(ytd-thumbnail)'
        ];

        let processedCount = 0;
        const elements = document.querySelectorAll(videoElementSelectors.join(','));

        // ä¼˜åŒ–ï¼šå¦‚æœå…ƒç´ æ•°é‡æ²¡æœ‰å˜åŒ–ï¼Œä¸”å·²ç»å¤„ç†è¿‡ç›¸åŒæ•°é‡ï¼Œåˆ™è·³è¿‡
        if (elements.length === lastProcessedCount && elements.length > 0) {
            // å¿«é€ŸéªŒè¯æ˜¯å¦æ‰€æœ‰å…ƒç´ éƒ½å·²å¤„ç†
            let allProcessed = true;
            for (const element of elements) {
                if (!element.hasAttribute(THUMBNAIL_PROCESSED_FLAG)) {
                    allProcessed = false;
                    break;
                }
            }
            if (allProcessed) return;
        }

        elements.forEach(element => {
            // ä¼˜åŒ–ï¼šæ›´å¿«çš„å·²å¤„ç†æ£€æŸ¥
            if (element.hasAttribute(THUMBNAIL_PROCESSED_FLAG)) {
                processedCount++;
                return;
            }

            // ä¼˜åŒ–ï¼šæ›´ç²¾ç¡®çš„ç¼©ç•¥å›¾å®¹å™¨æŸ¥æ‰¾
            let thumbnailContainer = element.querySelector('ytd-thumbnail a, #thumbnail');
            if (!thumbnailContainer) return;

            const videoInfo = getVideoInfoFromElement(element);
            if (!videoInfo) return;

            const button = document.createElement('button');
            button.className = THUMBNAIL_BUTTON_CLASS;
            button.textContent = 'ğŸ“ æ€»ç»“';
            button.title = 'ä½¿ç”¨Geminiæ€»ç»“æ­¤è§†é¢‘';

            // ä¼˜åŒ–ï¼šç®€åŒ–äº‹ä»¶å¤„ç†
            const eventHandler = (e) => {
                if (e.type === 'click') {
                    return handleThumbnailButtonClick(e, videoInfo);
                }
                e.stopPropagation();
                e.preventDefault();
                return false;
            };

            button.addEventListener('click', eventHandler, { capture: true, passive: false });
            button.addEventListener('mousedown', eventHandler, { capture: true, passive: false });

            // æœç´¢é¡µé¢ç‰¹æ®Šå¤„ç†
            if (isSearchPage) {
                // ç›‘å¬è§†é¢‘é¢„è§ˆ
                const observer = new MutationObserver((mutations) => {
                    for (const mutation of mutations) {
                        if (mutation.addedNodes.length > 0) {
                            for (const node of mutation.addedNodes) {
                                if (node.nodeType === Node.ELEMENT_NODE &&
                                    (node.tagName === 'VIDEO' ||
                                     node.classList?.contains('ytp-inline-preview-scrim') ||
                                     node.classList?.contains('html5-video-player'))) {
                                    // å¼ºåˆ¶æ˜¾ç¤ºæŒ‰é’®
                                    button.style.opacity = '1';
                                    button.style.zIndex = '99999';
                                    button.style.pointerEvents = 'auto';
                                    button.style.visibility = 'visible';
                                }
                            }
                        }
                    }
                });

                observer.observe(element, {
                    childList: true,
                    subtree: true
                });

                // ä¿å­˜observerå¼•ç”¨ä»¥ä¾¿æ¸…ç†
                button._observer = observer;
            }

            // ç¡®ä¿å®¹å™¨æœ‰ç›¸å¯¹å®šä½
            if (getComputedStyle(thumbnailContainer).position === 'static') {
                thumbnailContainer.style.position = 'relative';
            }

            thumbnailContainer.appendChild(button);
            element.setAttribute(THUMBNAIL_PROCESSED_FLAG, 'true');
            processedCount++;
        });

        lastProcessedCount = elements.length;
    }

    // --- ä¼˜åŒ–åçš„æ™ºèƒ½é˜²æŠ–å‡½æ•° ---
    function debouncedAddThumbnailButtons() {
        if (debounceTimer) {
            clearTimeout(debounceTimer);
        }
        debounceTimer = setTimeout(() => {
            addThumbnailButtons();
            debounceTimer = null;
        }, 200); // 200msé˜²æŠ–ï¼Œå¹³è¡¡å“åº”æ€§å’Œæ€§èƒ½
    }

    // --- ä¼˜åŒ–åçš„ç¼©ç•¥å›¾æŒ‰é’®ç³»ç»Ÿè®¾ç½® ---
    function setupThumbnailButtonSystem() {
        // ç«‹å³æ‰§è¡Œä¸€æ¬¡
        addThumbnailButtons();

        // ä¼˜åŒ–ï¼šä½¿ç”¨é˜²æŠ–çš„MutationObserver
        const obs = new MutationObserver(() => {
            // åªåœ¨éè§†é¢‘é¡µé¢æ‰§è¡Œ
            if (!isVideoPage()) {
                debouncedAddThumbnailButtons();
            }
        });

        obs.observe(document.body, {
            childList: true,
            subtree: true,
            // ä¼˜åŒ–ï¼šåªè§‚å¯Ÿå¿…è¦çš„å±æ€§å˜åŒ–
            attributes: false,
            attributeOldValue: false,
            characterData: false,
            characterDataOldValue: false
        });

        // ä¼˜åŒ–ï¼šä¿ç•™setIntervalä½œä¸ºå¤‡ç”¨ï¼Œä½†é¢‘ç‡é™ä½
        setInterval(() => {
            if (!isVideoPage()) {
                // åªåœ¨å…ƒç´ æ•°é‡å‘ç”Ÿå˜åŒ–æ—¶æ‰æ‰§è¡Œ
                const currentElementCount = document.querySelectorAll('ytd-rich-item-renderer, ytd-video-renderer').length;
                if (currentElementCount !== lastProcessedCount) {
                    addThumbnailButtons();
                }
            }
        }, 3000); // ä»1500mså¢åŠ åˆ°3000ms

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        if (document.readyState === 'complete') {
            setTimeout(addThumbnailButtons, 800);
        } else {
            window.addEventListener('load', () => setTimeout(addThumbnailButtons, 800), { once: true });
        }
    }

    // --- è§†é¢‘é¡µé¢æŒ‰é’®åŠŸèƒ½ (ä¿®å¤å®¹å™¨é€‰æ‹©) ---
    function addYouTubeActionButtons() {
        if (!isVideoPage()) {
            removeYouTubeActionButtonsIfExists();
            return;
        }

        if (document.getElementById(SUMMARY_BUTTON_ID) || document.getElementById(SUBTITLE_BUTTON_ID)) return;

        // ä¿®å¤ï¼šä½¿ç”¨æ›´å¯é çš„å®¹å™¨é€‰æ‹©é€»è¾‘
        const container = document.querySelector('ytd-masthead #end') ||
                          document.querySelector('ytd-masthead #buttons') ||
                          document.querySelector('ytd-masthead .ytd-masthead-right') ||
                          document.querySelector('#masthead-container #end') ||
                          document.querySelector('#container.ytd-masthead #end') ||
                          document.querySelector('ytd-masthead');

        if (!container) {
            console.log('YouTube Gemini Script: æ— æ³•æ‰¾åˆ°åˆé€‚çš„å®¹å™¨æ¥æ”¾ç½®æŒ‰é’®');
            return;
        }

        const buttonsWrapper = document.createElement('div');
        buttonsWrapper.style.display = 'inline-flex';
        buttonsWrapper.style.alignItems = 'center';
        buttonsWrapper.style.marginRight = '16px';

        const subtitleButton = document.createElement('button');
        subtitleButton.id = SUBTITLE_BUTTON_ID;
        subtitleButton.textContent = 'ğŸ¯ ç”Ÿæˆå­—å¹•';
        Object.assign(subtitleButton.style, {
            backgroundColor: '#28a745',
            color: 'white',
            border: 'none',
            borderRadius: '18px',
            padding: '0 16px',
            margin: '0 8px 0 0',
            cursor: 'pointer',
            fontWeight: '500',
            height: '36px',
            display: 'inline-flex',
            alignItems: 'center',
            justifyContent: 'center',
            fontSize: '14px',
            zIndex: '100',
            whiteSpace: 'nowrap',
            transition: 'all 0.2s ease'
        });

        const summaryButton = document.createElement('button');
        summaryButton.id = SUMMARY_BUTTON_ID;
        summaryButton.textContent = 'ğŸ“ Geminiæ‘˜è¦';
        Object.assign(summaryButton.style, {
            backgroundColor: '#1a73e8',
            color: 'white',
            border: 'none',
            borderRadius: '18px',
            padding: '0 16px',
            margin: '0',
            cursor: 'pointer',
            fontWeight: '500',
            height: '36px',
            display: 'inline-flex',
            alignItems: 'center',
            justifyContent: 'center',
            fontSize: '14px',
            zIndex: '100',
            whiteSpace: 'nowrap',
            transition: 'all 0.2s ease'
        });

        const mediaQuery = window.matchMedia('(max-width: 768px)');
        const adjustForMobile = () => {
            if (mediaQuery.matches) {
                subtitleButton.style.fontSize = '12px';
                subtitleButton.style.padding = '0 10px';
                subtitleButton.style.height = '32px';
                summaryButton.style.fontSize = '12px';
                summaryButton.style.padding = '0 10px';
                summaryButton.style.height = '32px';
            } else {
                subtitleButton.style.fontSize = '14px';
                subtitleButton.style.padding = '0 16px';
                subtitleButton.style.height = '36px';
                summaryButton.style.fontSize = '14px';
                summaryButton.style.padding = '0 16px';
                summaryButton.style.height = '36px';
            }
        };

        mediaQuery.addEventListener('change', adjustForMobile);
        adjustForMobile();

        subtitleButton.addEventListener('click', handleGenerateSubtitlesClick);
        summaryButton.addEventListener('click', handleSummarizeClick);

        buttonsWrapper.appendChild(subtitleButton);
        buttonsWrapper.appendChild(summaryButton);

        // ä¿®å¤ï¼šæ”¹è¿›æ’å…¥é€»è¾‘ï¼Œæä¾›æ›´å¤šå¤‡é€‰ä½ç½®
        const insertTargets = [
            container.querySelector('#create-icon'),
            container.querySelector('button[aria-label*="åˆ›å»º"]'),
            container.querySelector('button[aria-label*="Create"]'),
            container.querySelector('#avatar-btn'),
            container.querySelector('ytd-notification-topbar-button-renderer'),
            container.querySelector('.ytd-masthead-right')
        ];

        let inserted = false;
        for (const target of insertTargets) {
            if (target) {
                container.insertBefore(buttonsWrapper, target);
                inserted = true;
                console.log('YouTube Gemini Script: æŒ‰é’®å·²æˆåŠŸæ’å…¥åˆ°', target);
                break;
            }
        }

        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„æ’å…¥ä½ç½®ï¼Œå°±æ’å…¥åˆ°å®¹å™¨çš„å¼€å¤´
        if (!inserted) {
            if (container.firstChild) {
                container.insertBefore(buttonsWrapper, container.firstChild);
            } else {
                container.appendChild(buttonsWrapper);
            }
            console.log('YouTube Gemini Script: æŒ‰é’®å·²æ’å…¥åˆ°å®¹å™¨çš„é»˜è®¤ä½ç½®');
        }
    }

    function handleSummarizeClick() {
        const youtubeUrl = window.location.href;
        const urlParams = new URLSearchParams(window.location.search);
        const videoId = urlParams.get('v');

        if (!isValidYouTubeVideoId(videoId)) {
            showNotification(
                YOUTUBE_NOTIFICATION_ID,
                "æ— æ³•è·å–æœ‰æ•ˆçš„è§†é¢‘IDï¼Œè¯·ç¡®è®¤å½“å‰æ˜¯å¦åœ¨YouTubeè§†é¢‘é¡µé¢ã€‚",
                { ...YOUTUBE_NOTIFICATION_STYLE, backgroundColor: '#d93025' },
                5000
            );
            return;
        }

        const titleSelectors = [
            'h1.ytd-watch-metadata',
            '#video-title',
            '#title h1',
            '.title',
            'yt-formatted-string.ytd-watch-metadata'
        ];

        let videoTitle = '';
        for (const selector of titleSelectors) {
            const titleElement = document.querySelector(selector);
            if (titleElement) {
                videoTitle = titleElement.textContent?.trim();
                if (videoTitle) break;
            }
        }

        if (!videoTitle) {
            videoTitle = document.title.replace(/ - YouTube$/, '').trim() || 'Unknown Video';
        }

        const videoInfo = {
            id: videoId,
            title: videoTitle,
            url: youtubeUrl
        };

        processVideoSummary(videoInfo);
    }

    function handleGenerateSubtitlesClick() {
        const youtubeUrl = window.location.href;
        const titleElement = document.querySelector('h1.ytd-watch-metadata, #video-title, #title h1, .title');
        const videoTitle = titleElement?.textContent?.trim() || document.title.replace(/ - YouTube$/, '').trim() || 'Unknown Video';
        let videoDurationInSeconds = 0;
        const durationMeta = document.querySelector('meta[itemprop="duration"]');
        if (durationMeta?.content) {
            const match = durationMeta.content.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
            if (match) {
                videoDurationInSeconds = 0;
                if (match[1]) videoDurationInSeconds += parseInt(match[1].replace('H', '')) * 3600;
                if (match[2]) videoDurationInSeconds += parseInt(match[2].replace('M', '')) * 60;
                if (match[3]) videoDurationInSeconds += parseInt(match[3].replace('S', ''));
            }
        }

        if (videoDurationInSeconds <= 0) {
            showNotification(YOUTUBE_NOTIFICATION_ID, "æ— æ³•è·å–è§†é¢‘æ—¶é•¿ï¼Œæ— æ³•å¯åŠ¨å­—å¹•ä»»åŠ¡ã€‚", { ...YOUTUBE_NOTIFICATION_STYLE, backgroundColor: '#d93025' }, 15000);
            return;
        }

        const firstSegmentEnd = Math.min(videoDurationInSeconds, 1200);
        const prompt = `${youtubeUrl}\n1.ä¸è¦æ·»åŠ è‡ªå·±çš„è¯­è¨€\n2.å˜æˆç®€ä½“ä¸­æ–‡ï¼Œæµç•…ç‰ˆæœ¬ã€‚\n\nYouTube\nè¯·æå–æ­¤è§†é¢‘ä»00:00:00åˆ°${new Date(firstSegmentEnd * 1000).toISOString().substr(11, 8)}çš„å®Œæ•´å­—å¹•æ–‡æœ¬ã€‚`;

        // ä¿®å¤é—®é¢˜3ï¼šç”Ÿæˆå”¯ä¸€ä¼šè¯ID
        const sessionId = generateSessionId();

        GM_setValue(PROMPT_KEY, prompt);
        GM_setValue(TITLE_KEY, `${videoTitle} (å­—å¹• 00:00:00-${new Date(firstSegmentEnd * 1000).toISOString().substr(11, 8)})`);
        GM_setValue(ORIGINAL_TITLE_KEY, videoTitle);
        GM_setValue(TIMESTAMP_KEY, Date.now());
        GM_setValue(ACTION_TYPE_KEY, 'subtitle');
        GM_setValue(VIDEO_TOTAL_DURATION_KEY, videoDurationInSeconds);
        GM_setValue(FIRST_SEGMENT_END_TIME_KEY, firstSegmentEnd);
        GM_setValue(SESSION_ID_KEY, sessionId);

        showNotification(YOUTUBE_NOTIFICATION_ID, `å·²è·³è½¬åˆ° Gemini ç”Ÿæˆå­—å¹•: 00:00:00 - ${new Date(firstSegmentEnd * 1000).toISOString().substr(11, 8)}...\n"${videoTitle}"`, YOUTUBE_NOTIFICATION_STYLE, 15000);
        window.open('https://gemini.google.com/', '_blank');
        copyToClipboard(prompt);
    }

    function removeYouTubeActionButtonsIfExists() {
        [SUMMARY_BUTTON_ID, SUBTITLE_BUTTON_ID].forEach(id => {
            const button = document.getElementById(id);
            if (button) button.remove();
        });
    }

    // --- é¡µé¢ç±»å‹æ£€æµ‹å‡½æ•° ---
    function detectYouTubePageType() {
        if (!document.body) return;

        let isHomePage = window.location.pathname === '/' || window.location.pathname === '/feed/subscriptions';
        let isChannelPage = window.location.pathname.includes('/channel/') ||
                          window.location.pathname.includes('/c/') ||
                          window.location.pathname.includes('/user/') ||
                          window.location.pathname.includes('/@');
        let isSearchPage = window.location.pathname === '/results';

        if (isHomePage) {
            document.body.setAttribute('data-is-home-page', 'true');
            document.body.setAttribute('data-page-subtype', 'home');
        } else {
            document.body.removeAttribute('data-is-home-page');
        }

        if (isChannelPage) {
            document.body.setAttribute('data-page-subtype', 'channels');
        } else if (isSearchPage) {
            document.body.setAttribute('data-page-type', 'search');
        }
    }

    // ä¿®å¤é—®é¢˜1ï¼šæ·»åŠ æ›´å¯é çš„URLå˜åŒ–æ£€æµ‹
    function setupUrlChangeDetection() {
        let lastUrl = location.href;

        // ç›‘å¬popstateäº‹ä»¶ï¼ˆæµè§ˆå™¨å‰è¿›/åé€€ï¼‰
        window.addEventListener('popstate', function() {
            if (location.href !== lastUrl) {
                lastUrl = location.href;
                handleUrlChange();
            }
        });

        // ç›‘å¬YouTubeçš„å¯¼èˆªäº‹ä»¶
        document.addEventListener('yt-navigate-finish', function() {
            if (location.href !== lastUrl) {
                lastUrl = location.href;
                handleUrlChange();
            }
        });

        // å¤‡ç”¨ï¼šä»ç„¶ä¿ç•™MutationObserver
        const urlObserver = new MutationObserver(() => {
            if (location.href !== lastUrl) {
                lastUrl = location.href;
                handleUrlChange();
            }
        });

        urlObserver.observe(document, { subtree: true, childList: true });

        // å¤„ç†URLå˜åŒ–çš„å‡½æ•°
        function handleUrlChange() {
            // æ¸…ç†ç¼“å­˜å’Œobservers
            processedElements.forEach((value, element) => {
                const button = element.querySelector(`.${THUMBNAIL_BUTTON_CLASS}`);
                if (button?._observer) {
                    button._observer.disconnect();
                }
            });
            processedElements.clear();
            lastProcessedCount = 0;

            setTimeout(() => {
                detectYouTubePageType();
                if (isVideoPage()) {
                    addYouTubeActionButtons();
                } else {
                    removeYouTubeActionButtonsIfExists();
                }
            }, 800);
        }
    }

    // --- é¡µé¢åˆå§‹åŒ– (ä¼˜åŒ–ç‰ˆ) ---
    if (window.location.hostname.includes('www.youtube.com')) {
        detectYouTubePageType();

        // ä¿®å¤é—®é¢˜1ï¼šä½¿ç”¨æ–°çš„URLæ£€æµ‹ç³»ç»Ÿ
        setupUrlChangeDetection();

        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            setupThumbnailButtonSystem();
            setTimeout(addYouTubeActionButtons, 800);

            // ä¼˜åŒ–ï¼šå‡å°‘æ£€æŸ¥é¢‘ç‡
            setInterval(() => {
                if (isVideoPage()) {
                    if (!document.getElementById(SUMMARY_BUTTON_ID) || !document.getElementById(SUBTITLE_BUTTON_ID)) {
                        console.log('YouTube Gemini Script: æ£€æµ‹åˆ°æŒ‰é’®ç¼ºå¤±ï¼Œå°è¯•é‡æ–°æ·»åŠ ');
                        addYouTubeActionButtons();
                    }
                }
                detectYouTubePageType();
            }, 8000); // ä»5000mså¢åŠ åˆ°8000ms
        } else {
            document.addEventListener('DOMContentLoaded', () => {
                detectYouTubePageType();
                setupThumbnailButtonSystem();
                setTimeout(addYouTubeActionButtons, 800);
            }, { once: true });
        }
    } else if (window.location.hostname.includes('gemini.google.com')) {
        // ä¿®å¤é—®é¢˜3ï¼šå¢åŠ ä¼šè¯IDéªŒè¯
        const prompt = GM_getValue(PROMPT_KEY);
        const timestamp = GM_getValue(TIMESTAMP_KEY, 0);
        const actionType = GM_getValue(ACTION_TYPE_KEY);
        const sessionId = GM_getValue(SESSION_ID_KEY);

        const referrerIsYouTube = document.referrer.includes('youtube.com');

        // å¢åŠ æ›´ä¸¥æ ¼çš„éªŒè¯æ¡ä»¶
        if (prompt && actionType && sessionId &&
            Date.now() - timestamp <= 60000 && // ç¼©çŸ­åˆ°1åˆ†é’Ÿ
            referrerIsYouTube) {

            setTimeout(() => {
                const textarea = document.querySelector('textarea, div[contenteditable="true"]');
                if (textarea) {
                    if (textarea.isContentEditable) textarea.textContent = prompt;
                    else textarea.value = prompt;

                    textarea.dispatchEvent(new Event('input', { bubbles: true, cancelable: true }));
                    textarea.dispatchEvent(new Event('change', { bubbles: true, cancelable: true }));

                    setTimeout(() => {
                        const sendBtn = document.querySelector('button[aria-label*="Send"],button[aria-label*="å‘é€"],button[aria-label*="æäº¤"],button[aria-label*="Run"],button[aria-label*="Submit"]');
                        if (sendBtn && !sendBtn.disabled) {
                            sendBtn.click();

                            // ç«‹å³æ¸…ç†ï¼Œé¿å…é‡å¤ä½¿ç”¨
                            setTimeout(() => {
                                GM_deleteValue(PROMPT_KEY);
                                GM_deleteValue(TITLE_KEY);
                                GM_deleteValue(ORIGINAL_TITLE_KEY);
                                GM_deleteValue(TIMESTAMP_KEY);
                                GM_deleteValue(ACTION_TYPE_KEY);
                                GM_deleteValue(VIDEO_TOTAL_DURATION_KEY);
                                GM_deleteValue(FIRST_SEGMENT_END_TIME_KEY);
                                GM_deleteValue(SESSION_ID_KEY);
                            }, 1000); // ç¼©çŸ­æ¸…ç†æ—¶é—´
                        }
                    }, 500);
                }
            }, 1200);
        }
    }
})();
